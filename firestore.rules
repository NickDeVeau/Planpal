rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read user documents
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // Allow authenticated users to read and write projects if they are contributors
    match /projects/{projectId} {
      allow read: if request.auth != null && request.auth.uid in resource.data.contributors;

      allow write: if request.auth != null && (
        resource.data.admin == request.auth.uid ||
        (request.auth.uid in resource.data.permissions && canPerformAction(request, resource)) ||
        !exists(/databases/$(database)/documents/projects/$(projectId)) // Allow creating new projects
      );

      function canPerformAction(request, resource) {
        let userId = request.auth.uid;
        let permissions = resource.data.permissions[userId];

        // Check if the user has the specific permission based on the data being modified
        return (
          (permissionCheck('categories', 'canEditTasks', permissions)) ||
          (permissionCheck('events', 'canEditEvents', permissions)) ||
          (permissionCheck('categories', 'canEditSections', permissions)) ||
          (permissionCheck('categories', 'canAddTasks', permissions)) ||
          (permissionCheck('events', 'canAddEvents', permissions)) ||
          (permissionCheck('categories', 'canDeleteTasks', permissions)) ||
          (permissionCheck('events', 'canDeleteEvents', permissions)) ||
          false
        );
      }

      function permissionCheck(field, permissionType, permissions) {
        return request.resource.data[field] == resource.data[field] || permissions[permissionType] == true;
      }
    }
  }
}